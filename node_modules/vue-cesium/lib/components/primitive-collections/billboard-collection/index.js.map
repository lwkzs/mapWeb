{"version":3,"file":"index.js","sources":["../../../../../../packages/components/primitive-collections/billboard-collection/index.ts"],"sourcesContent":["import type { PropType, VNode, WatchStopHandle } from 'vue'\nimport { createCommentVNode, defineComponent, getCurrentInstance, h, onUnmounted, watch } from 'vue'\nimport { VcComponentInternalInstance, VcComponentPublicInstance, VcPickEvent, VcReadyObject } from '@vue-cesium/utils/types'\nimport { usePrimitiveCollections } from '@vue-cesium/composables'\nimport { cloneDeep, differenceBy } from 'lodash-unified'\nimport { scene, blendOption, show, enableMouseEvent, debugShowBoundingVolume, modelMatrix } from '@vue-cesium/utils/cesium-props'\nimport { addCustomProperty, kebabCase } from '@vue-cesium/utils/util'\nimport { hSlot } from '@vue-cesium/utils/private/render'\nimport { primitiveCollectionEmits } from '@vue-cesium/utils/emits'\nimport { VcBillboardProps } from '../billboard'\n\nexport const billboardCollectionProps = {\n  ...scene,\n  ...blendOption,\n  ...show,\n  ...enableMouseEvent,\n  ...modelMatrix,\n  ...debugShowBoundingVolume,\n  billboards: {\n    type: Array as PropType<Array<VcBillboardProps>>,\n    default: () => []\n  }\n}\nexport default defineComponent({\n  name: 'VcCollectionBillboard',\n  props: billboardCollectionProps,\n  emits: primitiveCollectionEmits,\n  setup(props, ctx) {\n    // state\n    const instance = getCurrentInstance() as VcComponentInternalInstance\n    instance.cesiumClass = 'BillboardCollection'\n    const primitiveCollectionsState = usePrimitiveCollections(props, ctx, instance)\n\n    // watcher\n    let unwatchFns: Array<WatchStopHandle> = []\n    unwatchFns.push(\n      watch(\n        () => cloneDeep(props.billboards),\n        (newVal, oldVal) => {\n          if (!instance.mounted) {\n            return\n          }\n          const billboardCollection = instance.cesiumObject as Cesium.BillboardCollection\n          if (newVal.length === oldVal.length) {\n            // 视为修改操作\n            // Treated as modified\n            const modifies: Array<any> = []\n            for (let i = 0; i < newVal.length; i++) {\n              const options = newVal[i]\n              const oldOptions = oldVal[i]\n\n              if (JSON.stringify(options) !== JSON.stringify(oldOptions)) {\n                modifies.push({\n                  newOptions: options,\n                  oldOptions: oldOptions\n                })\n              }\n            }\n\n            modifies.forEach(modify => {\n              // TODO: 连续绘制 Pin 切换时 billboardCollection._billboards 中有undefined的对象。\n              const modifyBillboard = billboardCollection._billboards.find(v => v?.id === modify.oldOptions.id)\n              modifyBillboard &&\n                Object.keys(modify.newOptions).forEach(prop => {\n                  if (modify.oldOptions[prop] !== modify.newOptions[prop]) {\n                    modifyBillboard[prop] = primitiveCollectionsState?.transformProp(prop, modify.newOptions[prop])\n                  }\n                })\n            })\n          } else {\n            const addeds: any = differenceBy(newVal, oldVal, 'id')\n            const deletes: any = differenceBy(oldVal, newVal, 'id')\n            const deleteBillboards: Array<Cesium.Billboard> = []\n            for (let i = 0; i < deletes.length; i++) {\n              const deleteBillboard = billboardCollection._billboards.find(v => v.id === deletes[i].id)\n              deleteBillboard && deleteBillboards.push(deleteBillboard)\n            }\n\n            deleteBillboards.forEach(v => {\n              billboardCollection.remove(v)\n            })\n            addBillboards(billboardCollection, addeds)\n          }\n        },\n        {\n          deep: true\n        }\n      )\n    )\n    instance.alreadyListening.push('billboards')\n    // methods\n    const addBillboards = (billboardCollection: Cesium.BillboardCollection, billboards) => {\n      for (let i = 0; i < billboards.length; i++) {\n        const billboardOptions = billboards[i] as Cesium.Billboard\n        billboardOptions.id = Cesium.defined(billboardOptions.id) ? billboardOptions.id : Cesium.createGuid()\n        const billboardOptionsTransform = primitiveCollectionsState?.transformProps(billboardOptions)\n        const billboard = billboardCollection.add(billboardOptionsTransform)\n        addCustomProperty(billboard, billboardOptionsTransform)\n      }\n    }\n    instance.createCesiumObject = async () => {\n      const options = primitiveCollectionsState?.transformProps(props)\n      const billboardCollection = new Cesium.BillboardCollection(options)\n      addBillboards(billboardCollection, props.billboards)\n      return billboardCollection\n    }\n\n    // life cycle\n    onUnmounted(() => {\n      unwatchFns.forEach(item => item())\n      unwatchFns = []\n    })\n\n    return () =>\n      ctx.slots.default\n        ? h(\n            'i',\n            {\n              class: kebabCase(instance.proxy?.$options.name || ''),\n              style: { display: 'none !important' }\n            },\n            hSlot(ctx.slots.default)\n          )\n        : createCommentVNode(kebabCase(instance.proxy?.$options.name || ''))\n  }\n})\n\nexport type VcCollectionBillboardProps = {\n  /**\n   * Must be passed in for billboards that use the height reference property or will be depth tested against the globe.\n   */\n  scene?: Cesium.Scene\n  /**\n   * The billboard blending option. The default is used for rendering both opaque and translucent billboards. However, if either all of the billboards are completely opaque or all are completely translucent, setting the technique to BlendOption.OPAQUE or BlendOption.TRANSLUCENT can improve performance by up to 2x.\n   */\n  blendOption?: number | Cesium.BlendOption\n  /**\n   * Determines if the billboards in the collection will be shown.\n   * Default Value: true\n   */\n  show?: boolean\n  /**\n   * The 4x4 transformation matrix that transforms each billboard from model to world coordinates.\n   */\n  modelMatrix?: Cesium.Matrix4\n  /**\n   * For debugging only. Determines if this primitive's commands' bounding spheres are shown.\n   * Default Value: false\n   */\n  debugShowBoundingVolume?: boolean\n  /**\n   * Specifies whether to respond to mouse pick events.\n   * Default Value: true\n   */\n  enableMouseEvent?: boolean\n  /**\n   * Specify an array of billboard collections. The structure of the array object is the same as the attribute of the [vc-billboard](https://zouyaoji.top/vue-cesium/#/en-US/component/primitives/vc-collection-billboard#vcbillboard-props) component.\n   */\n  billboards?: Array<VcBillboardProps>\n  /**\n   * Triggers before the VcCollectionBillboard is loaded.\n   */\n  onBeforeLoad?: (instance: VcComponentInternalInstance) => void\n  /**\n   * Triggers when the VcCollectionBillboard is successfully loaded.\n   */\n  onReady?: (readyObject: VcReadyObject) => void\n  /**\n   * Triggers when the component load failed.\n   */\n  onUnready?: (e: any) => void\n  /**\n   * Triggers when the VcCollectionBillboard is destroyed.\n   */\n  onDestroyed?: (instance: VcComponentInternalInstance) => void\n  /**\n   * Triggers when the mouse is pressed on this collection.\n   */\n  onMousedown?: (evt: VcPickEvent) => void\n  /**\n   * Triggers when the mouse bounces up on this collection.\n   */\n  onMouseup?: (evt: VcPickEvent) => void\n  /**\n   * Triggers when the mouse clicks on this collection.\n   */\n  onClick?: (evt: VcPickEvent) => void\n  /**\n   * Triggers when the mouse clicks outside this collection.\n   */\n  onClickout?: (evt: VcPickEvent) => void\n  /**\n   * Triggers when the left mouse button double-clicks this collection.\n   */\n  onDblclick?: (evt: VcPickEvent) => void\n  /**\n   * Triggers when the mouse moves on this collection.\n   */\n  onMousemove?: (evt: VcPickEvent) => void\n  /**\n   * Triggers when the mouse moves over to this collection.\n   */\n  onMouseover?: (evt: VcPickEvent) => void\n  /**\n   *  Triggers when the mouse moves out of this collection.\n   */\n  onMouseout?: (evt: VcPickEvent) => void\n}\n\nexport type VcCollectionBillboardRef = VcComponentPublicInstance<VcCollectionBillboardProps>\n\nexport interface VcCollectionBillboardSlots {\n  /**\n   * Slot for vc-billboard.\n   */\n  default: () => VNode[]\n}\n"],"names":["scene","blendOption","show","enableMouseEvent","modelMatrix","debugShowBoundingVolume","defineComponent","primitiveCollectionEmits","getCurrentInstance","usePrimitiveCollections","watch","cloneDeep","differenceBy","addCustomProperty","onUnmounted","h","kebabCase","hSlot","createCommentVNode"],"mappings":"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"}